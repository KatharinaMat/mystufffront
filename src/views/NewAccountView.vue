<template>
  <div class="container text-center">
    <div>
      <h1>MyStuffLabelled</h1>
    </div>
    <div class="row justify-content-center mb-3">
      <div class="col col-6">
        <AlertSuccess :alert-message="alertSuccessMessage"/>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <LoginCreateAccountMenu/>
      </div>
    </div>
    <div v-if="displayAddUserForm" class="row justify-content-center">
      <div class="col col-4">
        <UsernameInput :username="user.username" :username-error="usernameError"
                       @event-username-updated="setUserUsername"/>
        <PasswordInput :password="user.password" :password-error="passwordError"
                       @event-password-updated="setUserPassword"/>
        <EmailInput :email="user.email" :email-error="emailError"
                      @event-email-updated = "setUserEmail"/>
        <!-- Honeypot field -->
        <input v-model="user.website" type="text" class="hp-field" autocomplete="off" tabindex="-1" />

        <!-- hCaptcha -->
        <div class="mb-3">
          <div ref="hcaptchaEl"></div>
          <div v-if="captchaError" class="text-danger mt-2">{{ captchaError }}</div>
        </div>

        <div class="form-floating">
          <button @click="addNewUser" type="button" class="btn btn-custom btn-large">Sign up!</button>
        </div>
      </div>
    </div>
  </div>
</template>
<style scoped>
h1 {
  margin-top: 30px; /* to push the h1 lower */
  margin-bottom: 40px; /*to push the next block lower*/
}
.hp-field {
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
  opacity: 0;
}

</style>

<script>
import AlertSuccess from "@/modal/AlertSuccess.vue";
import LoginCreateAccountMenu from "@/components/LoginCreateAccountMenu.vue";
import UserService from "@/services/UserService";
import NavigationService from "@/services/NavigationService";
import UsernameInput from "@/components/inputs/UsernameInput.vue";
import PasswordInput from "@/components/inputs/PasswordInput.vue";
import EmailInput from "@/components/inputs/EmailInput.vue";
import UsernameService from "@/services/UsernameService";
import PasswordService from "@/services/PasswordService";
import EmailService from "@/services/EmailService";


export default {
  name: 'NewAccountView',
  components: {EmailInput, PasswordInput, UsernameInput, LoginCreateAccountMenu, AlertSuccess},
  data() {
    return {
      alertSuccessMessage: '',
      displayAddUserForm: true,

      usernameError: '',
      passwordError: '',
      emailError: '',

      user: {
        username: '',
        password: '',
        email: '',
        website: '' // honeypot
      },

      errorResponse: {
        message: '',
        errorCode: 0
      }
    }
  },
  methods: {

    addNewUser() {
      this.resetValidationErrors()
      this.validateFromInput()
      if (!this.formInputIsCorrect()) return

      const payload = {
        username: this.user.username.trim(),
        password: this.user.password,
        email: this.user.email.trim(),
        website: this.user.website // honeypot
      }
        UserService.sendPostUserRequest(payload)
            .then(() => this.handleAddNewUserResponse(payload.username))
            .catch(error => this.handleAddNewUserError(error))
    },

    handleAddNewUserResponse(trimmedUsername) {
      this.hideAddUserForm()
      this.alertSuccessMessage = 'New user "' + trimmedUsername + '" added! You can now login'
      setTimeout(NavigationService.navigateToLoginView, 8000)
    },

    hideAddUserForm() {
      this.displayAddUserForm = false
    },

    validateFromInput() {
      this.usernameError = UsernameService.validateSignupUsername(this.user.username)
      this.passwordError = PasswordService.validateSignupPassword(this.user.password)
      this.emailError = EmailService.validateSignupEmail(this.user.email)
      },

    formInputIsCorrect() {
      return this.usernameError === '' && this.passwordError === '' && this.emailError === ''
    },

    handleAddNewUserError(error) {
      const status = error?.response?.status
      this.errorResponse = error?.response?.data || { message: 'Unknown error', errorCode: 0 }

      if (status === 403 && this.errorResponse.errorCode === 222) {
        this.usernameError = this.errorResponse.message
        return
      }
      if (status === 403 && this.errorResponse.errorCode === 223) {
        this.emailError = this.errorResponse.message
        return
      }
      if (status === 400) {
        const msg = this.errorResponse.message || 'Please check your input'
        if (msg.toLowerCase().includes('username')) this.usernameError = msg
        else if (msg.toLowerCase().includes('password')) this.passwordError = msg
        else if (msg.toLowerCase().includes('email')) this.emailError = msg
        else this.emailError = msg
        return
      }
      NavigationService.navigateToErrorView()
    },
    resetValidationErrors() {
      this.usernameError = ''
      this.passwordError = ''
      this.emailError = ''
    },
    setUserUsername(username) {
      this.user.username = username
    },
    setUserPassword(password) {
      this.user.password = password
    },
    setUserEmail(email) {
      this.user.email = email
    }
  }
}
</script>